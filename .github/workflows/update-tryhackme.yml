name: Update TryHackMe Stats

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch: # Manual trigger

jobs:
  update-tryhackme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch TryHackMe badge
        run: |
          curl -s -o tryhackme-badge.png "https://tryhackme-badges.s3.amazonaws.com/lily442.png"

      - name: Fetch TryHackMe stats JSON
        run: |
          curl -s "https://tryhackme.com/api/v2/public-profile?username=lily442" -o api_response.json

      - name: Extract stats
        run: |
          level=$(jq -r '.data.level' api_response.json)
          streak=$(jq -r '.data.streak' api_response.json)
          rank=$(jq -r '.data.rank' api_response.json)
          rooms=$(jq -r '.data.completedRoomsNumber' api_response.json)
          toppercent=$(jq -r '.data.topPercentage' api_response.json)

          echo "$level" > tryhackme-level.txt
          echo "$streak" > tryhackme-streak.txt
          echo "$rank" > tryhackme-rank.txt
          echo "$rooms" > tryhackme-rooms.txt
          echo "$toppercent" > tryhackme-toppercent.txt

      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add tryhackme-badge.png tryhackme-level.txt tryhackme-streak.txt tryhackme-rank.txt tryhackme-rooms.txt tryhackme-toppercent.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update TryHackMe stats" && git push)
